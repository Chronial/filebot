
package net.sourceforge.filebot.ui.panel.sfv;


import java.io.BufferedOutputStream;
import java.io.File;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.OutputStream;
import java.io.PrintStream;
import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.Map;
import java.util.Map.Entry;

import net.sourceforge.filebot.ui.transfer.FileExportHandler;
import net.sourceforge.tuned.FileUtil;


public class ChecksumTableExportHandler extends FileExportHandler {
	
	private final ChecksumTableModel model;
	
	
	public ChecksumTableExportHandler(ChecksumTableModel model) {
		this.model = model;
	}
	

	@Override
	public boolean canExport() {
		return model.getRowCount() > 0 && model.getChecksumColumnCount() > 0;
	}
	

	@Override
	public void export(OutputStream out) throws IOException {
		export(out, model.getChecksumColumn(0));
	}
	

	@Override
	public String getDefaultFileName() {
		return getDefaultFileName(model.getChecksumColumn(0));
	}
	

	public void export(File file, File column) throws IOException {
		OutputStream out = new BufferedOutputStream(new FileOutputStream(file));
		
		try {
			export(out, column);
		} finally {
			out.close();
		}
	}
	

	public void export(OutputStream out, File column) throws IOException {
		PrintStream printer = new PrintStream(out);
		
		SimpleDateFormat date = new SimpleDateFormat("yyyy-MM-dd");
		SimpleDateFormat time = new SimpleDateFormat("HH:mm:ss");
		
		Date now = new Date();
		printer.println("; Generated by FileBot on " + date.format(now) + " at " + time.format(now));
		printer.println(";");
		printer.println(";");
		
		Map<String, Checksum> checksumMap = model.getChecksumColumn(column);
		
		for (Entry<String, Checksum> entry : checksumMap.entrySet()) {
			printer.println(String.format("%s %s", entry.getKey(), entry.getValue()));
		}
	}
	

	public String getDefaultFileName(File column) {
		String name = "";
		
		if (column != null)
			name = FileUtil.getFileName(column);
		
		if (name.isEmpty())
			name = "name";
		
		return name + ".sfv";
	}
	
}
