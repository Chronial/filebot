
package net.sourceforge.filebot.ui.panel.sfv;


import java.io.File;
import java.io.IOException;
import java.io.PrintWriter;
import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.Map;
import java.util.Map.Entry;

import net.sourceforge.filebot.ui.transfer.TextFileExportHandler;
import net.sourceforge.tuned.FileUtilities;


public class ChecksumTableExportHandler extends TextFileExportHandler {
	
	private final ChecksumTableModel model;
	
	
	public ChecksumTableExportHandler(ChecksumTableModel model) {
		this.model = model;
	}
	

	@Override
	public boolean canExport() {
		return model.getRowCount() > 0 && model.getChecksumColumnCount() > 0;
	}
	

	@Override
	public void export(PrintWriter out) {
		export(out, model.getChecksumColumn(0));
	}
	

	@Override
	public String getDefaultFileName() {
		return getDefaultFileName(model.getChecksumColumn(0));
	}
	

	public void export(File file, File column) throws IOException {
		PrintWriter out = new PrintWriter(file, "UTF-8");
		
		try {
			export(out, column);
		} finally {
			out.close();
		}
	}
	

	public void export(PrintWriter out, File column) {
		
		SimpleDateFormat date = new SimpleDateFormat("yyyy-MM-dd");
		SimpleDateFormat time = new SimpleDateFormat("HH:mm:ss");
		
		Date now = new Date();
		out.println("; Generated by FileBot on " + date.format(now) + " at " + time.format(now));
		out.println(";");
		out.println(";");
		
		Map<String, Checksum> checksumMap = model.getChecksumColumn(column);
		
		for (Entry<String, Checksum> entry : checksumMap.entrySet()) {
			out.println(String.format("%s %s", entry.getKey(), entry.getValue()));
		}
	}
	

	public String getDefaultFileName(File column) {
		String name = "";
		
		if (column != null)
			name = FileUtilities.getName(column);
		
		if (name.isEmpty())
			name = "name";
		
		return name + ".sfv";
	}
	
}
